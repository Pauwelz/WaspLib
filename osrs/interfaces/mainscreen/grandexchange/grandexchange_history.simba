

{$DEFINE WL_GRANDEXCHANGE_HISTORY_INCLUDED}
{$INCLUDE_ONCE WaspLib/osrs.simba}

type

  TRSGrandExchangeHistory = record
    Title: TRSInterfaceTitle;
    Scroll: TRSScrollBar;
    Bounds: TBox;
    ExchangeButton: TBox;
  end;

function TRSGrandExchangeHistory.IsOpen(): Boolean; forward;


procedure TRSGrandExchangeHistory.SetupInterface();
begin
  Self.Bounds := GrandExchange.Bounds;

  Self.Scroll.Area.X1 := Self.Bounds.X1 + 10;
  Self.Scroll.Area.Y1 := Self.Bounds.Y1 + 40;
  Self.Scroll.Area.X2 := Self.Bounds.X2 - 26;
  Self.Scroll.Area.Y2 := Self.Bounds.Y2 - 14;

  Self.Scroll.Setup();

  Self.Title.Setup(Self.Bounds);
  Self.Title.IsOpen := @Self.IsOpen;

  with Self.Bounds do
    Self.ExchangeButton := [X1+7, Y1+7, X1+63, Y1+26];
end;


function TRSGrandExchangeHistory.IsOpen(): Boolean;
begin
  if BankPin.IsOpen() then
  begin
    if not BankPin.WaitLoading(3000) then
      raise GetDebugLn('BankPin', 'GrandExchangeHistory pin buttons don''t seem to have loaded in 3 seconds.');

    if not BankPin.Enter(Profiles.GetPin()) then
      raise GetDebugLn('BankPin', 'Failed to enter GrandExchangeHistory pin.');
  end;

  Result := Self.Title.IsTitle('Grand Exchange Trade History');
end;


function TRSGrandExchangeHistory.WaitOpen(time: Integer; interval: Integer = -1): Boolean;
begin
  if interval < 0 then interval := RandomMode(100, 50, 1500);
  Result := SleepUntil(Self.IsOpen(), interval, time);
end;


function TRSGrandExchangeHistory.Close(escape: Boolean): Boolean;
begin
  Result := Self.Title.Close(escape);
end;

function TRSGrandExchangeHistory.Close(escapeProbability: Single = -1): Boolean; overload;
begin
  Result := Self.Title.Close(escapeProbability);
end;


property TRSGrandExchangeHistory.Slots: TBoxArray;
var
  tpa: TPointArray;
  b, slot, offset: TBox;
  h: Integer;
begin
  with Self.Bounds do
    tpa := Target.FindColor(RSColors.TEXT_ORANGE, 0, [X1+42, Y1+80, X1+92, Y2-80]);
  if tpa = [] then Exit;

  for tpa in tpa.Cluster(20, 20) do
  begin
    b := tpa.Bounds();
    case b.Height of
      9:  slot := [b.X1-36, b.Y1-16, b.X1+411, b.Y1+29];
      11: slot := [b.X1-36, b.Y1-18, b.X1+411, b.Y1+27];
      else Continue;
    end;
    Break;
  end;

  if slot = Default(TBox) then Exit;

  Result += slot;
  offset := slot;
  h := slot.Height;
  repeat
    offset := offset.Offset([0,-h]);
    b := offset.Clip(Self.Scroll.Area);
    if b.Height > 32 then
      Result += offset;
  until offset.Y1 < Self.Scroll.Area.Y1;

  repeat
    offset := offset.Offset([0,h]);
    b := offset.Clip(Self.Scroll.Area);
    if b.Height > 32 then
      Result += offset;
  until offset.Y2 > Self.Scroll.Area.Y2;
end;


function TRSGrandExchangeHistory.Open(): Boolean;
begin
  if Self.IsOpen() then Exit(True);
  if not GrandExchange.IsOpen() then Exit;

  Mouse.Click(GrandExchange.HistoryButton, EMouseButton.LEFT);
  Result := Self.WaitOpen(2000);
end;

var

  GrandExchangeHistory: TRSGrandExchangeHistory;
