

{$DEFINE WL_FRAMERECORDER_INCLUDED}
{$INCLUDE_ONCE WaspLib/utils.simba}

type

  TFrameRecorder = record
    FPS: Integer;
    Directory: String;
    FrameCount: Integer;
  end;


procedure TFrameRecorder.Start(fps: Integer = 25; dir: String = '');
var
  selectedDir: String;
  imagesDir: String;
begin
  if not Target.IsValid then
    raise 'No target to screenshot';
    
  Self.FPS := fps;
  Self.FrameCount := 0;
  
  if dir = '' then
  begin
    imagesDir := SimbaEnv.SimbaPath + 'Images';
    if not DirExists(imagesDir) then
      DirCreate(imagesDir);
      
    if ShowDirectoryDialog('Select directory for screenshots', imagesDir, selectedDir) then
      Self.Directory := selectedDir + PATH_SEP + 'sequence_' + TDateTime.CreateFromSystem().ToString('YYYY-MM-DD_HH-mm-ss') + PATH_SEP
    else
      TerminateScript('No directory selected - capture cancelled');
  end
  else
    Self.Directory := dir;
    
  if not DirExists(Self.Directory) then
    DirCreate(Self.Directory);
    
  WriteLn('Frame recorder initialized:');
  WriteLn('  FPS: ', Self.FPS);
  WriteLn('  Directory: ', Self.Directory);
  WriteLn('Press ESC to stop recording');
end;


procedure TFrameRecorder.Run();
var
  frameTime: Integer;
begin
  frameTime := 1000 div Self.FPS;
  
  repeat
    Inc(Self.FrameCount);
    SaveScreenshot(Self.Directory + ToStr(Self.FrameCount).PadLeft(5, '0'));
    WriteLn('Frame ', Self.FrameCount, ' saved');
    
    Sleep(frameTime);
  until Target.KeyPressed(EKeyCode.ESCAPE);
  
  WriteLn('Capture stopped. Total frames: ', Self.FrameCount);
end;
